<div class="modal fade" id="modalVenda" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0 overflow-hidden">

      <!-- Cabeçalho -->
      <div class="modal-header bg-success text-white py-3">
        <h5 class="modal-title fw-bold d-flex align-items-center">
          <i class="bi bi-cart-plus me-2 fs-4"></i>
          Registrar Venda
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Corpo -->
      <div class="modal-body p-4" [formGroup]="formVenda">

        <!-- PESQUISA -->
        <input type="text" class="form-control mb-4 shadow-sm rounded-3" placeholder="Pesquisar produtos..."
          (input)="filtrar($event)">

        <!-- TABELA -->
        <div class="table-responsive shadow-sm rounded-4 border">
          <table class="table align-middle m-0">

            <thead>
              <tr>
                <th>✔</th>
                <th>Produto</th>
                <th>Marca</th>
                <th>Preço Unit.</th>
                <th class="text-center">Quantidade / Peso</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let p of paginaAtualProdutos; trackBy: trackById" [formGroup]="getFormGroupById(p.id!)">

                <td class="text-center">
                  <input type="checkbox" formControlName="selecionado" (change)="atualizarTotal()">
                </td>

                <td class="fw-semibold text-dark">{{ p.detalhe }}</td>

                <td class="text-muted">{{ p.marca }}</td>

                <td class="fw-bold text-success">
                  R$ {{ p.precoVenda | number:'1.2-2' }}
                </td>

                <td class="text-center">

                  <!-- QUANTIDADE -->
                  <input type="number" class="form-control form-control-sm qty-input" formControlName="quantidadeVenda"
                    min="1" (input)="atualizarTotal()" [disabled]="
                      !getFormGroupById(p.id!).value.selecionado ||
                      getFormGroupById(p.id!).value.vendaPorPeso
                    ">

                  <!-- Checkbox PESO -->
                  <div class="form-check d-flex justify-content-center align-items-center gap-2 mt-1">
                    <input type="checkbox" class="form-check-input" formControlName="vendaPorPeso"
                      (change)="atualizarTotal()" [disabled]="!getFormGroupById(p.id!).value.selecionado">
                    <label class="form-check-label small text-secondary">
                      Peso?
                    </label>
                  </div>

                  <!-- Valor Peso -->
                  <input *ngIf="getFormGroupById(p.id!).value.vendaPorPeso" type="number"
                    class="form-control form-control-sm qty-input mt-1" placeholder="Valor R$"
                    formControlName="valorPeso" min="0.01" step="0.01" (input)="atualizarTotal()"
                    [disabled]="!getFormGroupById(p.id!).value.selecionado">

                </td>

              </tr>
            </tbody>

          </table>
        </div>

        <!-- PAGINADOR -->
        <div class="d-flex justify-content-between align-items-center mt-3 px-2">

          <button class="btn btn-outline-success btn-sm px-3 rounded-pill" (click)="paginaAnterior()"
            [disabled]="paginaAtual === 1">
            <i class="bi bi-chevron-left"></i>
            Anterior
          </button>

          <span class="fw-semibold text-secondary small">
            Página {{ paginaAtual }} de {{ totalPaginas }}
          </span>

          <button class="btn btn-outline-success btn-sm px-3 rounded-pill" (click)="proximaPagina()"
            [disabled]="paginaAtual === totalPaginas">
            Próxima
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

        <div *ngIf="itensSelecionados.length > 0" class="mt-4">
          <h5 class="fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-cart-fill me-2"></i>
            SUBTOTAL
          </h5>

          <div class="p-3 rounded-4 shadow-sm border bg-white">

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">

                <thead style="background: #e9eef5;" class="text-dark fw-semibold">
                  <tr>
                    <th class="py-3">Produto</th>
                    <th class="py-3">Marca</th>
                    <th class="py-3">Qtd / Peso</th>
                    <th class="py-3 text-end">Preço</th>
                  </tr>
                </thead>

                <tbody>

                  <tr *ngFor="let item of itensSelecionados" class="align-middle">
                    <td class="fw-semibold text-dark">
                      {{ item.detalhe }}
                    </td>

                    <td class="text-muted">
                      {{ item.marca }}
                    </td>

                    <td class="fw-semibold">
                      {{ item.quantidadeVenda }} un
                    </td>

                    <td class="text-end" style="color: #db3b3b;">

                      <span *ngIf="!item.vendaPorPeso">
                        R$ {{ item.precoVenda * item.quantidadeVenda | number:'1.2-2' }}
                      </span>
                      <span *ngIf="item.vendaPorPeso">
                        R$ {{ item.valorPeso | number:'1.2-2' }}
                      </span>
                    </td>
                  </tr>

                </tbody>

              </table>
            </div>

          </div>
        </div>


        <!-- FORMA DE PAGAMENTO -->
        <div class="mt-4">
          <label class="fw-bold mb-1">Forma de Pagamento</label>
          <select class="form-select shadow-sm" formControlName="formaPagamento">
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">Pix</option>
            <option value="debito">Cartão de Débito</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
        </div>

        <!-- CHECKBOX TROCO -->
        <div *ngIf="formaPagamento === 'dinheiro'" class="form-check mt-3">
          <input type="checkbox" class="form-check-input" formControlName="precisaTroco" (change)="calcularTroco()">
          <label class="form-check-label fw-semibold">
            Precisa de troco?
          </label>
        </div>

        <!-- VALOR RECEBIDO -->
        <div *ngIf="formaPagamento === 'dinheiro' && precisaTroco" class="mt-2">
          <input type="number" class="form-control shadow-sm" formControlName="valorRecebido" (input)="calcularTroco()"
            min="0" step="0.01" placeholder="Valor recebido (R$)">
        </div>

        <!-- CARDS DE TOTAIS -->
        <div class="row mt-4 g-3">

          <div class="col-md-4">
            <div class="p-3 rounded-4 bg-info bg-opacity-25 shadow-sm">
              <div class="fw-bold">Total:</div>
              <div class="fs-4 fw-bold">
                R$ {{ total | number:'1.2-2' }}
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="p-3 rounded-4 bg-success bg-opacity-25 shadow-sm">
              <div class="fw-bold">Lucro:</div>
              <div class="fs-4 fw-bold text-success">
                R$ {{ lucro | number:'1.2-2' }}
              </div>
            </div>
          </div>

          <div *ngIf="formaPagamento === 'dinheiro' && precisaTroco" class="col-md-4">
            <div class="p-3 rounded-4 bg-warning bg-opacity-25 shadow-sm">
              <div class="fw-bold">Troco:</div>
              <div class="fs-4 fw-bold text-warning">
                R$ {{ troco | number:'1.2-2' }}
              </div>
            </div>
          </div>

        </div>

      </div>

      <!-- Rodapé -->
      <div class="modal-footer p-3">
        <button class="btn btn-secondary px-4" data-bs-dismiss="modal">
          Cancelar
        </button>

        <button class="btn btn-success px-4" data-bs-dismiss="modal" (click)="finalizarVenda()">
          <i class="bi bi-check-circle me-1"></i>
          Finalizar Venda
        </button>
      </div>

    </div>
  </div>
</div>
